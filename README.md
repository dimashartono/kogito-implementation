# E-Commerce Order Processing System

A order processing system built with Java 17, Quarkus, Kafka, and Kogito BPMN.

## Overview

This system demonstrates modern microservices architecture with event-driven processing and business process automation:

1. **Kafka Stream Processor** - Processes orders from Kafka, performs fraud detection, data enrichment, and persists to PostgreSQL
2. **Kogito Checkout Service** - BPMN-based checkout process that validates cart, processes payment, reserves stock, and publishes to Kafka

## Technology Stack

- **Programming Language**: Java 17
- **Framework**: Quarkus 3.6.4
- **BPMN Engine**: Kogito 1.44.1
- **Message Broker**: Apache Kafka 7.5.3
- **Database**: PostgreSQL 16
- **Build Tool**: Maven 3.9+
- **Container**: Docker & Docker Compose

## Prerequisites

- Java 17 or higher
- Maven 3.9+
- Docker and Docker Compose
- Git

## Quick Start

```bash
git clone repo
cd order-processing-system
```

```bash
docker-compose up -d
```

- Zookeeper (port 2181)
- Kafka (port 9092)
- Kafka UI (port 8080) - http://localhost:8080
- PostgreSQL (port 5432)
- pgAdmin (port 5050) - http://localhost:5050

**Verify services are running:**

```bash
docker-compose ps
```

### Build All Modules

```bash
mvn clean install
```

### Run Kafka Stream Processor

```bash
cd kafka-stream-processor
mvn quarkus:dev
```

Service will start on **http://localhost:8081**

### 5. Run Kogito Checkout Service

```bash
cd kogito-checkout-service
mvn quarkus:dev
```

Service will start on **http://localhost:8082**

## API Documentation

### Kogito Checkout Service (Port 8082)

#### Start Checkout Process

**Automatically generated by Kogito from BPMN:**

```bash
POST http://localhost:8082/checkoutProcess
Content-Type: application/json

{
  "order": {
    "orderId": "ORD-12345",
    "customer": {
      "customerId": "CUST-001",
      "name": "John Doe",
      "email": "john@example.com",
      "phone": "+6281234567890",
      "isVerified": true,
      "totalOrders": 5
    },
    "items": [
      {
        "productId": "P001",
        "productName": "Laptop ASUS ROG",
        "sku": "LAPTOP-ROG-001",
        "quantity": 1,
        "unitPrice": 15000000,
        "category": "ELECTRONICS",
        "weightGrams": 2500
      }
    ],
    "shippingAddress": {
      "street": "Jl. Sudirman No. 123",
      "city": "Jakarta Selatan",
      "province": "DKI Jakarta",
      "postalCode": "12190",
      "country": "Indonesia"
    },
    "payment": {
      "method": "CREDIT_CARD",
      "amount": 15000000,
      "currency": "IDR"
    },
    "voucherCode": "WELCOME10"
  }
}
```

**Response:**

```json
{
  "id": "process-instance-id",
  "orderId": "ORD-12345",
  "paymentSuccess": true,
  "orderCreated": true
}
```

### Kafka Stream Processor (Port 8081)

#### Admin Endpoints

```bash
# Get processing statistics
GET http://localhost:8081/api/admin/stats

# Get recent orders
GET http://localhost:8081/api/admin/orders/recent?limit=10

# Get order by ID
GET http://localhost:8081/api/admin/orders/{orderId}

# Get fraud alerts
GET http://localhost:8081/api/admin/fraud-alerts?reviewed=false
```

### Health Checks

```bash
# Checkout Service
GET http://localhost:8082/q/health

# Stream Processor
GET http://localhost:8081/q/health
```

### Swagger UI

- Checkout Service: http://localhost:8082/swagger-ui
- Stream Processor: http://localhost:8081/swagger-ui

## BPMN Checkout Process Explanation

The checkout process is defined in [`kogito-checkout-service/src/main/resources/com/ecommerce/checkout/checkout-process.bpmn`](kogito-checkout-service/src/main/resources/com/ecommerce/checkout/checkout-process.bpmn)


## Kafka Topics

1. **raw-orders** 
2. **validated-orders**
3. **fraud-alerts**

## Database Schema

### Tables

1. **order_audit_log** 
2. **fraud_alerts** 
3. **order_stats** 

### PostgreSQL Access

**Via pgAdmin:**
- URL: http://localhost:5050
- Email: admin@ecommerce.com
- Password: admin

**Via psql:**

```bash
docker exec -it ecommerce-postgres psql -U ecommerce_user -d ecommerce_orders
```

**Fraud Score Thresholds:**
- **0-30**: Low Risk → Auto Approve
- **31-70**: Medium Risk → Approve with Monitoring
- **71-100**: High Risk → Manual Review

## Testing

### Run All Tests

```bash
mvn test
```

### Run Tests for Specific Module

```bash
# Shared Models
cd shared-models && mvn test

# Kafka Stream Processor
cd kafka-stream-processor && mvn test

# Kogito Checkout Service
cd kogito-checkout-service && mvn test
```

### Docker Build

```bash
# Build native executables 
mvn package -Pnative -Dquarkus.native.container-build=true

# Build JVM-based Docker images
mvn package
```

## Monitoring & Observability

### Metrics (Prometheus)

```bash
# Stream Processor
curl http://localhost:8081/q/metrics

# Checkout Service
curl http://localhost:8082/q/metrics
```

### Health Checks

```bash
# Liveness
curl http://localhost:8081/q/health/live

# Readiness
curl http://localhost:8081/q/health/ready
```

## Troubleshooting

### Kafka Connection Issues

```bash
# Check if Kafka is running
docker-compose ps kafka

# View Kafka logs
docker-compose logs kafka

# Restart Kafka
docker-compose restart kafka
```

### Database Connection Issues

```bash
# Check PostgreSQL logs
docker-compose logs postgres

# Test connection
docker exec -it ecommerce-postgres pg_isready
```

### Application Logs

Quarkus dev mode provides live logs. For production:

```bash
# View logs
docker-compose logs kafka-stream-processor
docker-compose logs kogito-checkout-service
```

## License

This project is created for educational and demonstration purposes.

### Sample Order JSON

See [Sample Order Request](#start-checkout-process) in API Documentation section.

### Payment Methods

- `CREDIT_CARD` - Credit card payment (95% success rate in simulation)
- `DEBIT_CARD` - Debit card payment (95% success rate)
- `E_WALLET` - E-wallet payment (98% success rate)
- `BANK_TRANSFER` - Bank transfer (100% success for demo)
- `COD` - Cash on Delivery (100% success at checkout)

### Voucher Codes (Demo)

- `WELCOME10` - 10% discount
- `SAVE20` - 20% discount
- `NEWYEAR` - 15% discount
